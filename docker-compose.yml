services:
  clickhouse:
    image: clickhouse/clickhouse-server:25.8
    container_name: moobot-clickhouse
    restart: unless-stopped
    environment:
      CLICKHOUSE_DB: marketdata
      CLICKHOUSE_USER: moobot
      CLICKHOUSE_PASSWORD: moobot
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "8123:8123" # HTTP
      - "9000:9000" # native
    volumes:
      - ${CLICKHOUSE_DATA_FOLDER:-ch_data}:/var/lib/clickhouse
      - ./db/clickhouse_init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query \"SELECT 1\""]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  ch_data:
